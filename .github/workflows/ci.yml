name: CI

on:
  push:
    branches: ["main", "feature/phase5-development"]
  pull_request:
    branches: ["main"]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run gitleaks scanner
        uses: zricethezav/gitleaks-action@v2
        with:
          args: --redact
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Validate OpenAPI (Spectral)
        run: |
          npx @stoplight/spectral@6 lint docs/openapi.yaml -r docs/spectral.yml || true
      - name: Install backend dependencies
        working-directory: backend
        run: npm ci
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      - name: Run backend lint (if configured)
        working-directory: backend
        run: |
          if [ -f package.json ]; then
            npm run lint || echo "No lint script"
          fi
      - name: Run frontend lint (if configured)
        working-directory: frontend
        run: |
          if [ -f package.json ]; then
            npm run lint || echo "No lint script"
          fi
      - name: Run backend tests (if present)
        working-directory: backend
        run: |
          if [ -f package.json ] && jq -r '.scripts.test // empty' package.json | grep -q .; then
            npm test || true
          else
            echo "No backend tests"
          fi
      - name: Run frontend tests (if present)
        working-directory: frontend
        run: |
          if [ -f package.json ] && jq -r '.scripts.test // empty' package.json | grep -q .; then
            npm test || true
          else
            echo "No frontend tests"
          fi
